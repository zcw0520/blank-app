import json
import os
import difflib
import streamlit as st

DATA_FILE = "default_course_structure"
EXTERNAL_COURSES_FILE = "my_courses.json"

# ================== èª²ç¨‹çµæ§‹ ==================
default_course_structure = {
    "æ ¡æ ¸å¿ƒå¿…ä¿®": {
        "ä¸­æ–‡é–±è®€èˆ‡æ›¸å¯«(ä¸€)": 2,
        "ä¸­æ–‡é–±è®€èˆ‡æ›¸å¯«(äºŒ)": 2,
        "è‹±æ–‡(ä¸€)": 2,
        "è‹±æ–‡(äºŒ)": 2,
        "é«”è‚²(ä¸€)": 1,
        "é«”è‚²(äºŒ)": 1
    },
    "é™¢æ ¸å¿ƒå¿…ä¿®": {
        "çµ„ç¹”èˆ‡ç¤¾æœƒ": 2,
        "é‹ç®—æ€ç¶­èˆ‡ç¨‹å¼è¨­è¨ˆ": 2
    },
    "ç³»åŸºç¤å¿…ä¿®": {
        "æ”¿æ²»å­¸": 3,
        "è¡Œæ”¿å­¸": 3,
        "ç¶“æ¿Ÿå­¸": 3,
        "æ³•å­¸ç·’è«–": 3,
        "ä¸­è¯æ°‘åœ‹æ†²æ³•èˆ‡æ”¿åºœ": 3,
        "ç®¡ç†å­¸": 3,
        "çµ±è¨ˆå­¸": 3,
        "ç¤¾æœƒç§‘å­¸ç ”ç©¶æ³•": 3,
        "å°ˆé¡Œèˆ‡å¯¦ç¿’": 3
    },
    "ç³»åŸºç¤é¸ä¿®": {
        "ä¼æ¥­æ¦‚è«–": 3,
        "ç¤¾æœƒå­¸": 3,
        "æœƒè¨ˆå­¸": 3,
        "æ‡‰ç”¨çµ±è¨ˆå­¸": 3,
        "è¡Œæ”¿ç®¡ç†ç†è«–": 2,
        "æ”¿æ²»ç¶“æ¿Ÿå­¸": 3,
        "è¡Œæ”¿æ³•(ä¸€)": 2,
        "æ°‘æ³•(ä¸€)": 2,
        "è¡Œæ”¿æ³•(äºŒ)": 2,
        "æ°‘æ³•(äºŒ)": 2,
        "è²¡æ”¿å­¸": 3,
        "å…¬å…±ç¶“æ¿Ÿå­¸": 3,
        "åˆ‘æ³•": 3,
        "ç¬¬ä¸‰éƒ¨é–€": 2,
        "å°ˆé–€è­°é¡Œç ”ç©¶": 2,
        "åœ‹éš›é—œä¿‚": 2,
        "å°ˆæ¥­è‹±æ–‡": 2
    },
    "çµ„ç¹”ç®¡ç†å­¸ç¾¤": {
        "çµ„ç¹”ç†è«–èˆ‡ç®¡ç†": 3,
        "å…¬å…±ç®¡ç†": 2,
        "çµ„ç¹”è¡Œç‚º": 3,
        "äººåŠ›è³‡æºç®¡ç†": 3,
        "æ¯”è¼ƒæ”¿åºœèˆ‡æ”¿æ²»": 2,
        "äººåŠ›è³‡æºèˆ‡çµ„ç¹”ç™¼å±•": 3,
        "ç¸¾æ•ˆèˆ‡è–ªé…¬ç®¡ç†": 3,
        "äººäº‹è¡Œæ”¿": 3,
        "æ”¿ç­–èˆ‡æ­£ç¾©": 2,
        "é›»å­æ²»ç†": 2,
        "ç®¡ç†è¡Œæ”¿å¯¦å‹™": 2
    },
    "å…¬ç§æ±ºç­–å­¸ç¾¤": {
        "å…¬å…±æ”¿ç­–(ä¸€)": 2,
        "å…¬å…±æ”¿ç­–(äºŒ)": 2,
        "å…©å²¸é—œä¿‚": 2,
        "å‰µæ„èˆ‡å‰µæ–°ç®¡ç†": 2,
        "æ”¿ç­–è¦åŠƒ": 2,
        "å•é¡Œåˆ†æèˆ‡æ±ºç­–": 2,
        "æ°‘æ„èª¿æŸ¥": 2,
        "ç­–ç•¥è¦åŠƒèˆ‡ç®¡ç†": 3,
        "æ”¿ç­–åŸ·è¡Œèˆ‡è©•ä¼°": 2,
        "æ±ºç­–èˆ‡åˆ¤æ–·åˆ†æ": 2,
        "å±æ©Ÿç®¡ç†": 2,
        "å…¬å…±äº‹å‹™ç®¡ç†å€‹æ¡ˆåˆ†æ": 2
    },
    "åœ°å€ç™¼å±•èˆ‡è¡ŒéŠ·å­¸ç¾¤": {
        "è¡ŒéŠ·ç®¡ç†": 3,
        "æ¶ˆè²»è€…è¡Œç‚º": 3,
        "éƒ½å¸‚èˆ‡åœ°æ–¹æ²»ç†": 3,
        "æ–‡åŒ–ç”¢æ¥­è¡ŒéŠ·": 2,
        "æœå‹™è¡ŒéŠ·": 3,
        "æ”¿åºœè«‡åˆ¤": 3,
        "æ”¿æ²»ç®¡ç†": 2,
        "åœ°å€ç¶“ç‡Ÿç®¡ç†": 2,
        "åœ°æ–¹ç™¼å±•èˆ‡åœ°å€è¡ŒéŠ·": 2,
        "å»£å‘Šåª’é«”": 3,
        "æ”¿ç­–è¡ŒéŠ·": 3,
        "è·¨åŸŸç®¡ç†": 2,
        "å…¬ç›Šå‰µæŠ•èˆ‡ç¤¾æœƒè¡ŒéŠ·": 3
    },
    "æ–‡å²å“²è—è¡“é ˜åŸŸ": {
        "ç¾åœ‹æ–‡åŒ–": 2,
        "è‹±æ–‡å°å“æ–‡è³æ": 2,
        "è‹±èªå£èªè¡¨é”æŠ€å·§": 2,
        "æ—…éŠè‹±æ–‡": 2,
        "æ™‚äº‹è‹±æ–‡": 2,
        "è‹±æ–‡å£èªè¡¨é”æŠ€å·§": 2,
        "è·å ´è‹±æ–‡": 2,
        "å°èªªèˆ‡ç¤¾æœƒé—œæ‡·": 2,
        "æ–‡å­¸èˆ‡ç¾ä»£ç”Ÿæ´»": 2,
        "è‡ºç£ç¶“å…¸æ–‡ç»é¸è®€": 2,
        "ç¶“å…¸æ–‡å­¸å°è®€": 2,
        "è‡ºç£æ­·å²èˆ‡æ–‡åŒ–": 2,
        "å½±åƒè—è¡“æ€ç¶­": 2,
        "æ”å½±è—è¡“": 2,
        "ç©ºé–“ç¾å­¸": 2,
        "éŸ³æ¨‚èˆ‡äººç”Ÿ": 2,
        "è¡¨æ¼”è—è¡“æ¬£è³": 2
    },
    "ç¤¾æœƒè„ˆå‹•é ˜åŸŸ": {
        "æ³•å¾‹ç´ é¤Š": 2,
        "çŠ¯ç½ªã€æ³•å¾‹èˆ‡äººæ¬Š": 2,
        "äºå¤ªåœ°å€åœ°ç·£æ”¿æ²»èˆ‡ä¸­åœ‹": 2,
        "æ”¿æ²»å­¸æ¦‚è¦": 2,
        "åœ‹éš›é—œä¿‚ç™¼å±•èˆ‡ç†è«–": 2,
        "è‡ºç£ä¸»æ¬Šåœ°ä½çš„åœ‹éš›è§€": 2,
        "è·å ´èˆ‡æ³•å¾‹": 2,
        "æœå‹™å­¸ç¿’èˆ‡ç¤¾æœƒé—œæ‡·": 2,
        "ç†è²¡è¦åŠƒ": 2,
        "ç®¡ç†å­¸æ¦‚è«–": 2,
        "é ˜å°è—è¡“": 2
    },
    "ç”Ÿå‘½ç§‘å­¸é ˜åŸŸ": {
        "ESGèˆ‡æ°¸çºŒç”Ÿæ´»è¨­è¨ˆ": 2,
        "æ°´è³‡æºåˆ©ç”¨èˆ‡ä¿è‚²": 2,
        "è‡ºç£è‡ªç„¶ä¿è‚²è­°é¡Œ": 2,
        "æµ·æ´‹ç”Ÿå‘½ç§‘å­¸å°è«–": 2,
        "ç”Ÿå‘½æ•™è‚²": 2,
        "å¤§å­¸ç”Ÿçš„å¹¸ç¦å­¸": 2,
        "ç”Ÿæ­»å­¸": 2,
        "ç”Ÿç‰©ç§‘æŠ€çš„æ‡‰ç”¨": 2,
        "é‹å‹•èˆ‡äººç”Ÿ": 2,
        "é‹å‹•çš„è—è¡“èˆ‡å¯¦è¸": 2
    },
    "ç§‘æŠ€æ¢ç´¢é ˜åŸŸ": {
        "AIäººæ–‡è—è¡“ä¹‹æ‡‰ç”¨": 2,
        "AIé‡è¦‹è¨­è¨ˆæ€è€ƒ": 2,
        "å¤§æ•¸æ“šåˆ†ææ¦‚è«–": 2,
        "ç”Ÿæˆå¼AIä¹‹é‹ç”¨": 2,
        "è¨ˆç®—æ©Ÿæ¦‚è«–èˆ‡ Python ç¨‹å¼è¨­è¨ˆ": 2,
        "æ©Ÿå™¨å­¸ç¿’æ¦‚è«–": 2,
        "æ©Ÿå™¨äººæ€ç¶­èˆ‡è¨­è¨ˆ": 2,
        "ç¶²è·¯è³‡æ–™æ¢å‹˜èˆ‡åˆ†æ": 2,
        "ç¶²é è¨­è¨ˆèˆ‡ç¶²ç«™å»ºç½®æ¦‚è«–": 2,
        "ç‰©è¯ç¶²æ‡‰ç”¨": 2,
        "è¡Œå‹•è£ç½®ç¨‹å¼è¨­è¨ˆ": 2
    },
    "é€šè­˜ä¸åˆ†é ˜åŸŸ": {
        "åšé›…æ•™è‚²è¬›åº§": 2
    },
    "è‡ªç”±é¸ä¿®": {}
}

# ================== è³‡æ–™å­˜å– ==================
def load_course_structure():
    if os.path.exists(EXTERNAL_COURSES_FILE):
        try:
            with open(EXTERNAL_COURSES_FILE, "r", encoding="utf-8") as f:
                return json.load(f)
        except Exception:
            pass
    return default_course_structure

course_structure = load_course_structure()

def init_data():
    if not os.path.exists(DATA_FILE):
        save_data({"å·²ä¿®èª²ç¨‹": {}})

def load_data():
    if not os.path.exists(DATA_FILE):
        init_data()
    with open(DATA_FILE, "r", encoding="utf-8") as f:
        return json.load(f)

def save_data(data):
    with open(DATA_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=4)

# ================== å·¥å…· ==================
def find_course(course_name):
    for cat, courses in course_structure.items():
        if course_name in courses:
            return cat, course_name, courses[course_name]
    all_names = []
    for cat, courses in course_structure.items():
        all_names += list(courses.keys())
    matches = difflib.get_close_matches(course_name, all_names, n=3, cutoff=0.6)
    if matches:
        best = matches[0]
        for cat, courses in course_structure.items():
            if best in courses:
                return cat, best, courses[best]
    return None, None, None

def total_credits():
    data = load_data()
    return sum(data["å·²ä¿®èª²ç¨‹"].values())

def check_three_core_groups():
    data = load_data()
    taken = data["å·²ä¿®èª²ç¨‹"]
    result = {}
    for group in ["çµ„ç¹”ç®¡ç†å­¸ç¾¤", "å…¬ç§æ±ºç­–å­¸ç¾¤", "åœ°å€ç™¼å±•èˆ‡è¡ŒéŠ·å­¸ç¾¤"]:
        total = 0
        for c, cr in taken.items():
            if c in course_structure.get(group, {}):
                total += cr
        result[group] = total
    return result

def check_general_ed():
    data = load_data()
    taken = data["å·²ä¿®èª²ç¨‹"]
    domains = ["æ–‡å²å“²è—è¡“é ˜åŸŸ", "ç¤¾æœƒè„ˆå‹•é ˜åŸŸ", "ç”Ÿå‘½ç§‘å­¸é ˜åŸŸ", "ç§‘æŠ€æ¢ç´¢é ˜åŸŸ"]
    domain_credits = {d: 0 for d in domains}
    for c, cr in taken.items():
        for d in domains:
            if c in course_structure.get(d, {}):
                domain_credits[d] += cr
    return domain_credits

# ================== Streamlit App ==================
st.set_page_config(page_title="ç•¢æ¥­å­¸åˆ†æª¢æŸ¥ç³»çµ±", layout="wide")
st.title("ğŸ“ ç•¢æ¥­å­¸åˆ†æª¢æŸ¥ç³»çµ±")

data = load_data()

# === åŠŸèƒ½é¸å–® ===
tab1, tab2 = st.tabs(["â• åŠ å…¥èª²ç¨‹", "ğŸ“Š ç•¢æ¥­æª¢æŸ¥"])

with tab1:
    st.subheader("æ–°å¢å·²ä¿®èª²ç¨‹")
    course_input = st.text_input("èª²ç¨‹åç¨±")
    if st.button("åŠ å…¥"):
        if course_input:
            cat, cname, credit = find_course(course_input)
            if cname:
                data["å·²ä¿®èª²ç¨‹"][cname] = credit
                save_data(data)
                st.success(f"âœ… å·²åŠ å…¥ {cname} ({credit}å­¸åˆ†)")
            else:
                st.error("âŒ æ‰¾ä¸åˆ°èª²ç¨‹ï¼Œè«‹ç¢ºèªåç¨±")

    if st.button("æ¸…é™¤æ‰€æœ‰å·²ä¿®èª²ç¨‹"):
        save_data({"å·²ä¿®èª²ç¨‹": {}})
        st.warning("âš ï¸ å·²æ¸…ç©ºè³‡æ–™")

    st.subheader("ğŸ“– å·²ä¿®èª²ç¨‹åˆ—è¡¨")
    if data["å·²ä¿®èª²ç¨‹"]:
        for c, cr in data["å·²ä¿®èª²ç¨‹"].items():
            st.write(f"- {c} ({cr} å­¸åˆ†)")
    else:
        st.write("å°šæœªåŠ å…¥èª²ç¨‹")

with tab2:
    st.subheader("ğŸ“Š ç•¢æ¥­æª¢æŸ¥å ±å‘Š")
    total = total_credits()
    st.metric("å·²ä¿®ç¸½å­¸åˆ†", total)

    # ç³»æ ¸å¿ƒå­¸ç¾¤
    st.write("### ğŸ“š ç³»æ ¸å¿ƒå­¸ç¾¤æª¢æŸ¥")
    three_groups = check_three_core_groups()
    cols = st.columns(3)
    for i, (g, cr) in enumerate(three_groups.items()):
        with cols[i]:
            st.metric(g, f"{cr} å­¸åˆ†", delta=f"éœ€æ±‚ â‰¥ 6 å­¸åˆ†")

    # é€šè­˜
    st.write("### ğŸŒ é€šè­˜é ˜åŸŸæª¢æŸ¥")
    ge = check_general_ed()
    cols = st.columns(4)
    for i, (d, cr) in enumerate(ge.items()):
        with cols[i]:
            st.metric(d, f"{cr} å­¸åˆ†", delta="éœ€æ±‚ â‰¥ 2 å­¸åˆ†")

    st.write("âš ï¸ ç³»æ ¸å¿ƒå¿…ä¿®ã€é¸ä¿®èˆ‡é€šè­˜çš„æœ€ä½å­¸åˆ†éœ€æ±‚å¯ä¾å­¸æ ¡è¦å®šä¿®æ”¹ã€‚")
